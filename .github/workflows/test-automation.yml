name: Java CI with Gradle - Test Automation

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œë¥¼ ìœ„í•œ ê¶Œí•œ

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Configure Gradle for optimal use in GitHub Actions, including caching of downloaded dependencies.
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

    # ìºì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # ì»´íŒŒì¼ í™•ì¸
    - name: Compile Java code
      run: ./gradlew compileJava compileTestJava

    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (JUnit 5 ê¸°ë°˜)
    - name: Run JUnit Tests
      run: ./gradlew test
      continue-on-error: false

    # ì»¤ìŠ¤í…€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (BasicTest.java)
    - name: Run BasicTest
      run: |
        echo "ğŸ® Running BasicTest for Tetris game requirements..."
        java -cp "build/classes/java/main:build/classes/java/test" tetris.BasicTest
      continue-on-error: true

    # ì»¤ìŠ¤í…€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (GameScreenTest.java) - ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ
    - name: Run GameScreenTest
      run: |
        echo "ğŸ–¥ï¸ Running GameScreenTest for UI requirements..."
        if [ -f "src/test/java/tetris/GameScreenTest.java" ]; then
          java -cp "build/classes/java/main:build/classes/java/test" tetris.GameScreenTest || echo "GameScreenTest completed with warnings"
        else
          echo "GameScreenTest.java not found, skipping..."
        fi
      continue-on-error: true

    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œ ìƒì„±
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: 'Test Results'
        path: 'build/test-results/test/*.xml'
        reporter: 'java-junit'

    # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ (ì„ íƒì‚¬í•­)
    - name: Generate Test Coverage Report
      run: ./gradlew jacocoTestReport
      continue-on-error: true

    # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥ (JAR íŒŒì¼)
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: tetris-jar
        path: build/libs/*.jar

    # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ì—…ë¡œë“œ
    - name: Upload test logs on failure
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: test-logs
        path: |
          build/reports/tests/test/
          build/test-results/test/

  # ì •ì  ì½”ë“œ ë¶„ì„ (ì„ íƒì‚¬í•­)
  static-analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582

    # ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
    - name: Run checkstyle
      run: ./gradlew checkstyleMain checkstyleTest
      continue-on-error: true

    # SpotBugs ì •ì  ë¶„ì„ (ì„ íƒì‚¬í•­)
    - name: Run SpotBugs
      run: ./gradlew spotbugsMain spotbugsTest
      continue-on-error: true